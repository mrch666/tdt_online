# Руководство по запуску сервера FastAPI

## Проблема и решение

### Исходная проблема
При запуске сервера на порту 7990 возникала ошибка:
```
ERROR: [WinError 10013] Сделана попытка доступа к сокету методом, запрещенным правами доступа
```

### Причина
Конфигурация сервера использовала порт по умолчанию 8000, хотя сервер запускался на порту 7990.

### Решение
1. Добавлена переменная `SERVER_PORT=7990` в файл `.env`
2. Обновлен файл `.env.example` с примером настройки
3. Улучшена обработка ошибок в функции загрузки изображений
4. Созданы тесты для проверки конфигурации портов

## Конфигурация портов

### Файл `.env`
```env
SERVER_PORT=7990
```

### Файл `app/config.py`
```python
SERVER_PORT = int(os.getenv("SERVER_PORT", 8000))
API_BASE_URL = f"http://localhost:{SERVER_PORT}"
```

## Запуск сервера

### Стандартный запуск
```bash
python -m uvicorn app.main:app --reload --port 7990 --host 0.0.0.0
```

### Использование конфигурации из `.env`
Сервер автоматически использует порт из переменной `SERVER_PORT` в файле `.env`.

### Проверка конфигурации
```bash
# Проверить, что порт правильно читается из .env
python -c "from app.config import Settings; print('Порт:', Settings.SERVER_PORT); print('URL:', Settings.API_BASE_URL)"
```

## Тестирование

### Запуск всех тестов
```bash
python run_tests.py
```

### Запуск основных тестов
```bash
python run_tests.py --basic
```

### Тесты для проверки конфигурации портов
- `tests/test_port_configuration.py` - проверка чтения порта из `.env`
- `tests/test_external_images_port_error.py` - тесты с ошибками портов
- `tests/test_external_images_port_fixed.py` - тесты с исправленными портами

## Улучшения обработки ошибок

### В функции `upload_to_main_api` добавлено:
1. Проверка размера файла перед отправкой
2. Детальное логирование URL API и параметров запроса
3. Обработка ошибок подключения и таймаутов
4. Увеличен таймаут для больших файлов (120 секунд)
5. Более информативные сообщения об ошибках

### Пример логирования:
```python
logger.info(f"Используем API URL: {api_url}")
logger.info(f"Размер файла для загрузки: {file_size} байт")
logger.info(f"Отправка запроса к API: {api_url}")
```

## Проверка работоспособности

### 1. Проверить, что сервер запущен
```bash
netstat -ano | findstr :7990
```

### 2. Проверить доступность API
```bash
curl http://localhost:7990/docs
```

### 3. Проверить конфигурацию
```bash
python -c "import os; from dotenv import load_dotenv; load_dotenv(); print('SERVER_PORT:', os.getenv('SERVER_PORT')); from app.config import Settings; print('Settings.SERVER_PORT:', Settings.SERVER_PORT)"
```

## Частые проблемы и решения

### Порт уже используется
Если порт 7990 уже используется другим процессом:
1. Измените `SERVER_PORT` в `.env` на другой порт (например, 7991)
2. Перезапустите сервер

### Ошибка подключения к API
Если возникает ошибка подключения к API:
1. Проверьте, что сервер запущен: `netstat -ano | findstr :7990`
2. Проверьте конфигурацию: `python -c "from app.config import Settings; print('API_BASE_URL:', Settings.API_BASE_URL)"`
3. Проверьте логи сервера на наличие ошибок

### Ошибка "API endpoint не найден"
Если возникает ошибка 404:
1. Проверьте, что endpoint `/modelgoods/image/` доступен
2. Проверьте, что сервер запущен с правильным приложением
3. Проверьте логи сервера

## Документация API

### Основные endpoint'ы
- `http://localhost:7990/docs` - документация Swagger UI
- `http://localhost:7990/redoc` - документация ReDoc
- `http://localhost:7990/modelgoods/image/` - загрузка изображений
- `http://localhost:7990/web/external-images/` - веб-страница внешних изображений

## Мониторинг

### Логирование
Логи сохраняются в файл `app.log` и выводятся в консоль.

### Проверка здоровья
```bash
# Проверить доступность API
curl http://localhost:7990/health
```

## Резервное копирование

### Файлы конфигурации
- `.env` - текущая конфигурация
- `.env.example` - пример конфигурации
- `app/config.py` - настройки приложения

### Резервные копии
- `app/main_backup.py` - резервная копия main.py
- `app/main_fixed.py` - исправленная версия main.py

## Обновление конфигурации

### Изменение порта
1. Отредактируйте файл `.env`:
   ```env
   SERVER_PORT=8000
   ```
2. Перезапустите сервер

### Добавление новых переменных
1. Добавьте переменную в `.env`
2. Добавьте чтение переменной в `app/config.py`
3. Обновите `.env.example`
4. Создайте тесты для проверки новой конфигурации