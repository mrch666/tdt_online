# Тест загрузки изображений для товаров

Этот тест проверяет работу загрузки изображений для товаров через хранимые процедуры Firebird.

## Описание теста

Тест выполняет следующие операции:
1. Скачивает тестовое изображение с внешнего URL
2. Проверяет существование товара с ID `000001002Qa{` в базе данных
3. Сохраняет изображение через хранимую процедуру `wp_SaveBlobToFile`
4. Проверяет, что файл успешно сохранен на диск
5. Проверяет информацию о изображении в базе данных
6. Удаляет тестовый файл через хранимую процедуру `wp_DeleteFile`

## Требования

1. Python 3.8+
2. Установленные зависимости:
   ```bash
   pip install -r requirements.txt
   pip install requests
   ```
3. Доступ к базе данных Firebird
4. Настроенные переменные окружения (см. `.env.example`)

## Запуск теста

### 1. Установите необходимые зависимости

```bash
pip install requests
```

### 2. Запустите тест

```bash
python test_image_upload_real.py
```

## Ожидаемый результат

При успешном выполнении теста вы увидите:

```
=== Тест загрузки изображения для товара ===
Тестовые данные:
  Model ID: 000001002Qa{
  URL изображения: https://st.aestatic.net/items-img-7/R/6/A/H/Af78ed7279796474391bea8325e44c3f1h.jpeg_960x960.jpg
  Ожидаемое имя файла: Активная пена "Active Foam Light" 1л ОР-00001703.jpg

1. Скачивание изображения...
   Изображение скачано успешно, размер: XXXXX байт

2. Проверка существования товара в БД...
   Товар найден: ID=000001002Qa{, imgext=...

3. Сохранение изображения через хранимую процедуру...
   Имя файла из БД: XXXXXXXXXX.jpg
   Путь для сохранения: C:\Program Files (x86)\tdt3\bases\img\
   ИЗОБРАЖЕНИЕ УСПЕШНО СОХРАНЕНО через хранимую процедуру

4. Проверка сохраненного файла...
   Файл существует: C:\Program Files (x86)\tdt3\bases\img\XXXXXXXXXX.jpg
   Размер файла: XXXXX байт
   РАЗМЕРЫ СОВПАДАЮТ!
   ПЕРВЫЕ 100 БАЙТ СОВПАДАЮТ!

5. Проверка информации о изображении через API...
   Информация из БД:
     Model ID: 000001002Qa{
     Имя файла: XXXXXXXXXX.jpg
     Расширение: jpg
     Дата изменения: 2026-02-20 19:15:30
   ИМЯ ФАЙЛА СОВПАДАЕТ!

6. Очистка: удаление тестового файла...
   ФАЙЛ УСПЕШНО УДАЛЕН
   Файл успешно удален с диска

=== ТЕСТ ЗАВЕРШЕН ===

✅ ВСЕ ТЕСТЫ ПРОЙДЕНЫ УСПЕШНО!
```

## Детали теста

### Тестовые данные
- **Model ID**: `000001002Qa{` - идентификатор товара
- **URL изображения**: `https://st.aestatic.net/items-img-7/R/6/A/H/Af78ed7279796474391bea8325e44c3f1h.jpeg_960x960.jpg`
- **Название товара**: Активная пена "Active Foam Light" 1л ОР-00001703
- **Расширение файла**: `.jpg`

### Проверяемые функции
1. **Скачивание изображения** - проверка работы с внешними ресурсами
2. **Работа с БД** - проверка существования товара и получение информации
3. **Хранимая процедура `wp_SaveBlobToFile`** - сохранение BLOB данных в файл
4. **Проверка файловой системы** - проверка существования и содержимого файла
5. **Хранимая процедура `wp_DeleteFile`** - удаление файла

### Переменные окружения
Тест использует следующие переменные окружения:
- `BASE_DIR` - базовый путь к каталогу с файлами (по умолчанию: `C:\Program Files (x86)\tdt3\bases`)
- `IMG_SUBDIR` - подкаталог для изображений (по умолчанию: `img`)

## Устранение неполадок

### Ошибка: "Библиотека 'requests' не установлена"
```bash
pip install requests
```

### Ошибка: "Товар с ID ... не найден в БД"
Тест автоматически создаст тестовую запись в таблице `modelgoods`.

### Ошибка: "Column unknown" при вызове хранимой процедуры
Убедитесь, что используется правильный синтаксис вызова процедуры:
- Для `wp_SaveBlobToFile`: позиционные параметры `(?, ?, ?)`
- Для `wp_DeleteFile`: f-строка без параметров

### Ошибка доступа к файловой системе
Убедитесь, что у приложения есть права на запись в каталог `C:\Program Files (x86)\tdt3\bases\img\`

## Примечания

1. Тест автоматически очищает за собой - удаляет созданный файл
2. Если товар не существует в БД, тест создаст тестовую запись
3. Тест проверяет как сохранение, так и удаление файлов
4. Все операции выполняются через хранимые процедуры Firebird

## Связанные файлы

- `app/routers/modelgoods_images.py` - основной код загрузки изображений
- `test_image_upload_real.py` - тестовый скрипт
- `.env.example` - пример файла с переменными окружения