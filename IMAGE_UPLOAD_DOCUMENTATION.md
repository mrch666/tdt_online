# Документация по сохранению файлов изображений товаров

## Обзор

Система загрузки изображений товаров использует комбинацию:
1. **База данных Firebird** - для хранения метаданных (расширение файла, дата изменения)
2. **Файловая система** - для хранения самих изображений
3. **Хранимые процедуры Firebird** - для операций с файлами
4. **FastAPI** - для предоставления REST API

## Архитектура

### Таблица modelgoods
```sql
-- Структура таблицы товаров
CREATE TABLE "modelgoods" (
    "id" VARCHAR(255) NOT NULL PRIMARY KEY,  -- ID товара
    "imgext" VARCHAR(10),                    -- Расширение файла (jpg, png, etc.)
    "changedate" TIMESTAMP                   -- Дата последнего изменения
);
```

### Хранимые процедуры

#### 1. wp_SaveBlobToFile
```sql
-- Сохраняет BLOB данные в файл
-- Параметры:
--   path: путь к каталогу
--   filename: имя файла
--   data: BLOB данные
-- Возвращает: 1 - успех, 0 - ошибка
SELECT * FROM "wp_SaveBlobToFile"(?, ?, ?)
```

#### 2. wp_DeleteFile
```sql
-- Удаляет файл
-- Параметры:
--   path: путь к каталогу
--   filename: имя файла
-- Возвращает: 1 - успех, 0 - ошибка
SELECT * FROM "wp_DeleteFile"('путь', 'имя_файла')
```

### Функции DEC64I0 и DEC64I1
```sql
-- Преобразуют ID товара в числовые значения для формирования имени файла
-- Пример: ID='000001002Qa{' -> DEC64I0=1, DEC64I1=633150
-- Имя файла: DEC64I0(ID) || '_' || DEC64I1(ID) || '.' || imgext
-- Результат: '1_633150.jpg'
```

## API Endpoints

### 1. Загрузка изображения
**POST** `/api/modelgoods/image/`

**Параметры:**
- `modelid` (form-data): ID товара
- `file` (form-data): файл изображения

**Логика работы:**
1. Извлекается расширение из имени файла (`file.filename.split('.')[-1]`)
2. Проверяется существование товара в БД
3. **Обновляется поле `imgext` в БД** с извлеченным расширением
4. Формируется имя файла: `DEC64I0(ID) + '_' + DEC64I1(ID) + '.' + imgext`
5. Изображение сохраняется через хранимую процедуру `wp_SaveBlobToFile`
6. Возвращается имя сохраненного файла

**Пример запроса:**
```bash
curl -X POST "http://localhost:8000/api/modelgoods/image/" \
  -F "modelid=000001002Qa{" \
  -F "file=@image.jpg"
```

**Пример ответа:**
```json
{
  "status": "success",
  "filename": "1_633150.jpg"
}
```

### 2. Получение информации об изображении
**GET** `/api/modelgoods/image/{modelid}`

**Параметры:**
- `modelid` (path): ID товара

**Пример ответа:**
```json
{
  "modelid": "000001002Qa{",
  "filename": "1_633150.jpg",
  "imgext": "jpg",
  "changedate": "2026-02-20 19:31:31.987000"
}
```

### 3. Удаление изображения
**DELETE** `/api/modelgoods/image/{modelid}`

**Параметры:**
- `modelid` (path): ID товара

**Логика работы:**
1. Получается имя файла из БД
2. Файл удаляется через хранимую процедуру `wp_DeleteFile`
3. Поле `imgext` в БД устанавливается в NULL
4. Поле `changedate` обновляется

**Пример ответа:**
```json
{
  "status": "success",
  "message": "Image deleted successfully"
}
```

## Формирование имени файла

### Алгоритм
1. **ID товара**: `000001002Qa{`
2. **Функции преобразования**:
   - `DEC64I0("000001002Qa{")` → `1`
   - `DEC64I1("000001002Qa{")` → `633150`
3. **Расширение**: извлекается из имени загружаемого файла
4. **Итоговое имя файла**: `1_633150.jpg`

### Примеры
| ID товара | DEC64I0 | DEC64I1 | Расширение | Имя файла |
|-----------|---------|---------|------------|-----------|
| 000001002Qa{ | 1 | 633150 | jpg | 1_633150.jpg |
| 000001002Qa{ | 1 | 633150 | png | 1_633150.png |
| 000001002Qa{ | 1 | 633150 | gif | 1_633150.gif |

## Переменные окружения

| Переменная | Описание | Значение по умолчанию |
|------------|----------|----------------------|
| `BASE_DIR` | Базовый путь к каталогу с файлами | `C:\Program Files (x86)\tdt3\bases` |
| `IMG_SUBDIR` | Подкаталог для изображений | `img` |

**Полный путь к файлу:**
```
{ BASE_DIR }\{ IMG_SUBDIR }\{ filename }
Пример: C:\Program Files (x86)\tdt3\bases\img\1_633150.jpg
```

## Обработка ошибок

### 1. Ошибка загрузки файла
**Код:** 500
**Причина:** Ошибка в хранимой процедуре `wp_SaveBlobToFile`
**Решение:** Проверить права доступа к файловой системе и параметры процедуры

### 2. Товар не найден
**Код:** 404
**Причина:** Товар с указанным ID не существует в БД
**Решение:** Проверить существование товара перед загрузкой

### 3. Ошибка удаления файла
**Код:** 200 (с предупреждением)
**Причина:** Файл не найден или нет прав на удаление
**Решение:** Запись в БД все равно очищается, но файл остается на диске

## Тестирование

### 1. Тест полного цикла
```bash
python test_image_upload_real.py
```
Проверяет:
- Скачивание изображения с внешнего URL
- Сохранение через хранимую процедуру
- Обновление записи в БД
- Проверку сохраненного файла
- Удаление тестового файла

### 2. Тест логики API
```bash
python test_api_logic.py
```
Проверяет:
- Извлечение расширения из имени файла
- Формирование имени файла с расширением
- Обновление БД перед сохранением
- Работу функций чтения и удаления

## Особенности реализации

### 1. Последовательность операций
**Важно:** Сначала обновляется БД, потом сохраняется файл
```python
# 1. Обновляем imgext в БД
db.execute("UPDATE modelgoods SET imgext = :imgext ...")

# 2. Получаем имя файла с расширением
filename = DEC64I0(id) + '_' + DEC64I1(id) + '.' + imgext

# 3. Сохраняем файл
db.execute("SELECT * FROM wp_SaveBlobToFile(?, ?, ?)", [path, filename, data])
```

### 2. Использование позиционных параметров
```python
# Правильно (работает):
db.execute("SELECT * FROM \"wp_SaveBlobToFile\"(?, ?, ?)", [path, filename, data])

# Неправильно (не работает с именованными параметрами):
db.execute("SELECT * FROM \"wp_SaveBlobToFile\"(:path, :filename, :data)", 
           {"path": path, "filename": filename, "data": data})
```

### 3. Формирование пути
```python
# Правильно (добавляем разделитель в конце):
img_path = os.path.join(base_dir, img_subdir) + os.sep

# Неправильно (нет разделителя):
img_path = os.path.join(base_dir, img_subdir)
```

## Мониторинг и логирование

### Логирование операций
```python
logger.info(f"Image saved via stored procedure: {filename}")
logger.error(f"Stored procedure error: {str(e)}")
```

### Проверка состояния
1. **Файловая система:** Проверить существование файла по пути
2. **База данных:** Проверить поля `imgext` и `changedate`
3. **API:** Вызвать endpoint получения информации об изображении

## Рекомендации по использованию

### 1. Подготовка товара
Перед загрузкой изображения убедитесь, что товар существует в БД:
```sql
SELECT "id" FROM "modelgoods" WHERE "id" = 'ID_ТОВАРА';
```

### 2. Поддерживаемые форматы
- JPEG/JPG
- PNG
- GIF
- BMP
- WebP

### 3. Ограничения
- Максимальный размер файла: определяется конфигурацией сервера
- Поддерживаемые расширения: любые, но рекомендуется использовать стандартные

### 4. Резервное копирование
Рекомендуется регулярно создавать резервные копии:
1. Файлов изображений
2. Таблицы `modelgoods`

## Устранение неполадок

### 1. Файл не сохраняется
**Проверьте:**
- Права доступа к каталогу `{BASE_DIR}\{IMG_SUBDIR}`
- Корректность параметров хранимой процедуры
- Наличие товара в БД

### 2. Имя файла без расширения
**Проверьте:**
- Поле `imgext` в БД (не должно быть NULL или пустым)
- Логику извлечения расширения из имени файла

### 3. Ошибка "Procedure unknown"
**Проверьте:**
- Наличие хранимых процедур `wp_SaveBlobToFile` и `wp_DeleteFile` в БД
- Использование позиционных параметров `(?, ?, ?)`

### 4. Русские символы в выводе
**Решение:** Использовать ASCII символы в логах и выводах тестов

## Ссылки

- [Код API](app/routers/modelgoods_images.py)
- [Тест полного цикла](test_image_upload_real.py)
- [Тест логики API](test_api_logic.py)
- [Документация тестов](TEST_IMAGE_UPLOAD.md)