# Общие правила проекта FastAPI

## Структура проекта
Проект следует архитектуре FastAPI с разделением на:
- `app/` - основное приложение
- `tests/` - тесты
- `.clinerules/` - правила для работы с Cline

## Ключевые ограничения

### 1. База данных (НЕИЗМЕНЯЕМА)
- **Запрещено** изменять структуру существующих таблиц
- **Запрещено** изменять типы данных полей
- **Можно только** добавлять связи между таблицами в `models.py`
- Все имена таблиц и полей в **нижнем регистре**
- Все обращения к БД использовать с `quote=True`

### 2. Типы данных
- `modelid`: всегда `CHAR(12)` - ровно 12 символов
- Пути: использовать оригинальные системные пути Windows
- BLOB: для передачи бинарных данных

### 3. Пути и расположение
- `fbclient.dll`: `C:\Program Files (x86)\tdt3\fbclient.dll`
- Изображения: `C:\Program Files (x86)\tdt3\bases\img`
- Конфигурация: через файл `.env`

## Работа с хранимыми процедурами

### wp_SaveBlobToFile
```sql
"wp_SaveBlobToFile" (
    "iPathDB" char(400),      -- путь к папке изображений
    "iPath" char(100),        -- только имя файла
    "iBlob" blob              -- содержимое файла
)
```

**Правильный вызов:**
```python
sql = text("""SELECT * FROM "wp_SaveBlobToFile"(:iPathDB, :iPath, :iBlob)""")
result = db.execute(sql, {
    'iPathDB': 'C:\\Program Files (x86)\\tdt3\\bases\\img',
    'iPath': 'filename.jpg',
    'iBlob': file_content
})
```

## Логирование
- Использовать `logger.getLogger("api")` для единообразия
- Логировать длину параметров при отладке
- Логировать ошибки с деталями параметров

## Тестирование
- Создавать тесты перед внесением изменений
- Тестировать граничные случаи (длина modelid, размеры файлов)
- Использовать pytest для запуска тестов

## Безопасность
- Валидация всех входных данных через Pydantic схемы
- Защита от SQL-инъекций через параметризованные запросы
- Безопасная работа с файлами

## Работа с Cline
1. **Перед изменением** - прочитать соответствующие правила в `.clinerules/`
2. **При ошибках** - проверять логирование длины параметров
3. **После изменений** - запускать тесты
4. **При сомнениях** - спрашивать у пользователя

## Частые ошибки и их решения

### Ошибка: "Value of parameter (0) is too long, expected 12, found 17"
**Причина**: Параметр передается как строка с ограничением 12 символов
**Решение**: Проверить тип параметра, использовать правильные типы данных

### Ошибка: "Firebird Client Library not found"
**Причина**: Неправильный путь к `fbclient.dll`
**Решение**: Использовать `C:\Program Files (x86)\tdt3\fbclient.dll`

### Ошибка: "Procedure unknown"
**Причина**: Неправильное имя процедуры или параметров
**Решение**: Использовать точные имена из документации