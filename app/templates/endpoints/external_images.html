<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Внешние изображения товаров</title>
    <style>
        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .product-card.has-failed-uploads {
            border-left: 4px solid #ff6b6b;
            background-color: #fff5f5;
        }
        
        .product-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .product-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .product-modelid {
            font-size: 1rem;
            color: #666;
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .image-container {
            width: 150px;
            height: 150px;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .image-clickable {
            cursor: pointer;
            border-color: #4dabf7;
        }
        
        .image-clickable:hover {
            border-color: #339af0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .image-gray {
            opacity: 0.6;
            cursor: not-allowed;
            border-color: #adb5bd;
        }
        
        .thumbnail {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: transform 0.3s ease;
            background-color: #f8f9fa;
        }
        
        .image-clickable .thumbnail:hover {
            transform: scale(1.1);
        }
        
        .image-gray .thumbnail {
            filter: grayscale(100%);
        }
        
        .status-badge {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 3px 8px;
            font-size: 11px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .filter-controls {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        .filter-checkbox {
            margin-right: 10px;
        }
        
        .filter-label {
            font-weight: bold;
            color: #495057;
        }
        
        .no-images {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 1.1rem;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.success {
            background-color: #40c057;
        }
        
        .notification.error {
            background-color: #fa5252;
        }
        
        .notification.info {
            background-color: #339af0;
        }
        
        .hidden-product {
            opacity: 0.7;
            background-color: #f8f9fa;
        }
        
        .hidden-badge {
            display: inline-block;
            background-color: #868e96;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Внешние изображения товаров</h1>
        
        <div class="filter-controls">
            <div class="form-check">
                <input class="form-check-input filter-checkbox" type="checkbox" id="showHidden" 
                       {% if show_hidden %}checked{% endif %}
                       onchange="toggleHiddenProducts(this.checked)">
                <label class="form-check-label filter-label" for="showHidden">
                    Показать скрытые товары
                </label>
            </div>
            <small class="text-muted d-block mt-2">
                Скрытые товары - это товары, у которых есть хотя бы одно успешно загруженное изображение.
                Изображения с ошибкой загрузки отображаются серым цветом и не кликабельны.
            </small>
        </div>
        
        {% if products %}
            <div id="products-container">
                {% for product_data in products %}
                    {% set product = product_data.product %}
                    {% set images = product_data.images %}
                    {% set has_failed_uploads = product_data.has_failed_uploads %}
                    
                    <div class="product-card {% if has_failed_uploads %}has-failed-uploads{% endif %}" 
                         id="product-{{ product.id }}" 
                         data-modelid="{{ product.id }}">
                        <div class="product-header">
                            <div class="product-title">{{ product.name }}</div>
                            <div>
                                <span class="product-modelid">modelid: {{ product.id }}</span>
                                {% if product_data.is_hidden %}
                                    <span class="hidden-badge">Скрыт</span>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if images %}
                            <div class="images-grid">
                                {% for image in images %}
                                    <div class="image-container 
                                        {% if image.is_approved == 1 and image.is_loaded_to_db == 0 %}image-gray{% endif %}
                                        {% if image.is_approved == 0 %}image-clickable{% endif %}"
                                        data-image-id="{{ image.id }}"
                                        data-image-url="{{ image.url }}"
                                        {% if image.is_approved == 0 %}onclick="processImage('{{ image.id }}')"{% endif %}>
                                        
                                        <img src="{{ image.url }}" 
                                             alt="Внешнее изображение для {{ product.id }}"
                                             class="thumbnail {% if image.is_approved == 1 and image.is_loaded_to_db == 0 %}grayscale{% endif %}"
                                             loading="lazy"
                                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE1MCIgaGVpZ2h0PSIxNTAiIGZpbGw9IiNGMEYwRjAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjNjY2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+SW1hZ2UgZXJyb3I8L3RleHQ+PC9zdmc+'">
                                        
                                        {% if image.is_approved == 1 and image.is_loaded_to_db == 0 %}
                                            <div class="status-badge">Ошибка загрузки</div>
                                        {% endif %}
                                        
                                        <div class="processing-overlay" id="processing-{{ image.id }}" style="display: none;">
                                            <div class="spinner"></div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    {% set approved_count = images|selectattr('is_approved', 'equalto', 1)|list|length %}
                                    {% set loaded_count = images|selectattr('is_loaded_to_db', 'equalto', 1)|list|length %}
                                    Изображений: {{ images|length }}, Подтверждено: {{ approved_count }}, Загружено в БД: {{ loaded_count }}
                                </small>
                            </div>
                        {% else %}
                            <div class="no-images">
                                Нет внешних изображений для этого товара
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-images">
                <h3>Нет товаров с внешними изображениями</h3>
                <p>Все изображения уже обработаны или нет доступных для обработки.</p>
            </div>
        {% endif %}
    </div>
    
    <div id="notification" class="notification"></div>
    
    <script>
        // Уведомления
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            
            // Показываем уведомление
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Скрываем через 5 секунд
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // Обработка изображения
        async function processImage(imageId) {
            const container = document.querySelector(`[data-image-id="${imageId}"]`);
            const processingOverlay = document.getElementById(`processing-${imageId}`);
            
            if (!container || container.classList.contains('image-gray')) {
                return;
            }
            
            // Показываем индикатор загрузки
            processingOverlay.style.display = 'flex';
            container.style.pointerEvents = 'none';
            
            try {
                const response = await fetch(`/web/external-images/${imageId}/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Успешная загрузка
                    showNotification(result.message || 'Изображение успешно загружено', 'success');
                    
                    if (result.hide_product) {
                        // Скрываем весь товар
                        const productCard = container.closest('.product-card');
                        productCard.style.opacity = '0.5';
                        productCard.style.pointerEvents = 'none';
                        
                        setTimeout(() => {
                            productCard.style.display = 'none';
                            showNotification('Товар скрыт из списка', 'info');
                        }, 1000);
                    }
                    
                    // Обновляем статус изображения
                    container.classList.remove('image-clickable');
                    container.classList.add('image-gray');
                    container.querySelector('.thumbnail').style.cursor = 'not-allowed';
                    container.onclick = null;
                    
                } else {
                    // Ошибка загрузки
                    if (result.image_gray) {
                        // Делаем миниатюру серой и некликабельной
                        container.classList.remove('image-clickable');
                        container.classList.add('image-gray');
                        container.querySelector('.thumbnail').style.cursor = 'not-allowed';
                        container.onclick = null;
                        
                        // Добавляем бейдж ошибки
                        const statusBadge = document.createElement('div');
                        statusBadge.className = 'status-badge';
                        statusBadge.textContent = 'Ошибка загрузки';
                        container.appendChild(statusBadge);
                    }
                    
                    showNotification(result.message || 'Ошибка при обработке изображения', 'error');
                }
            } catch (error) {
                console.error('Ошибка сети:', error);
                showNotification('Ошибка сети при обработке изображения', 'error');
            } finally {
                // Скрываем индикатор загрузки
                processingOverlay.style.display = 'none';
                container.style.pointerEvents = 'auto';
            }
        }
        
        // Переключение показа скрытых товаров
        function toggleHiddenProducts(show) {
            const url = new URL(window.location);
            if (show) {
                url.searchParams.set('show_hidden', 'true');
            } else {
                url.searchParams.delete('show_hidden');
            }
            window.location.href = url.toString();
        }
        
        // Предзагрузка изображений при наведении
        document.addEventListener('DOMContentLoaded', function() {
            const images = document.querySelectorAll('.thumbnail');
            images.forEach(img => {
                // Предзагрузка при наведении
                img.parentElement.addEventListener('mouseenter', function() {
                    if (!img.complete) {
                        const preloadImg = new Image();
                        preloadImg.src = img.src;
                    }
                });
            });
        });
    </script>
</body>
</html>